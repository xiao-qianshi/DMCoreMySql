function initControl(){var n,t,i,r,u;$('[data-toggle="tooltip"]').tooltip({html:!0}).on("show.bs.tooltip",function(){var n="...";!selectid||$.ajax({url:"/PatientManage/PatVisit/GetWeightLogs",data:{keyValue:selectid},dataType:"json",async:!1,success:function(t){t.length>0&&(n="",$.each(t,function(t,i){n=n+"<em>"+i.time+"<\/em>&nbsp; &nbsp; &nbsp; <b>"+i.value+"<\/b><br>"}))}});$('[data-toggle="tooltip"]').attr("data-original-title",n)});$("#date-list").bindSelect();$("#visitNo").bindSelect();$("#patient-list").on("click",function(n){if(selectid=n.target.id,selectid==""&&(selectid=n.target.parentNode.id),selectid===undefined||selectid===null||selectid===""||selectid==="patient-list")return selectid="",currentPid="",pgdId="",!1;$(".list-group-item.active").removeClass("active");$("#"+selectid).addClass("active");$.each(list,function(n,t){if(t.Id==selectid)return currentPid=t.Pid,!1});queryHistory();$("#date-list").val(selectid).trigger("change");setForm()});$("#visitDate").val((new Date).Format("yyyy-MM-dd"));$("#groupName").bindSelect({url:"/SystemManage/ItemsData/GetSelectJson?enCode=BedGroup",id:"id",text:"text",change:function(){refreshList()}});$("#leftContent").css({height:$(window).height()-115});$("#mainContent").css({height:$(window).height()-80});$("#btn-refresh").on("click",function(){handleVisitDateChange()});$("#gridListOrders").dataGrid({datatype:"local",height:180,colModel:[{label:"主键",name:"F_Id",hidden:!0},{label:"代码",name:"F_OrderCode",hidden:!0},{label:"名称",name:"F_OrderText",width:140,align:"left"},{label:"规格",name:"F_OrderSpec",width:60,align:"center"},{label:"剂量",name:"F_OrderAmount",width:50,align:"center"},{label:"频次",name:"F_OrderFrequency",width:50,align:"center"},{label:"途径",name:"F_OrderAdministration",width:60,align:"center"},{label:"开单医生",name:"F_Doctor",width:60,align:"center"},{label:"执行护士",name:"F_Nurse",width:60,align:"center"},{label:"执行时间",name:"F_NurseOperatorTime",width:60,align:"left",formatter:"time",formatoptions:{srcformat:"Y-m-d h:m:s",newformat:"Y-m-d h:m"}}],sortname:"F_NurseOperatorTime asc",viewrecords:!0});$("#gridListObs").dataGrid({datatype:"local",height:180,colModel:[{label:"主键",name:"F_Id",hidden:!0,key:!0},{label:"时间",name:"F_NurseOperatorTime",width:40,align:"left",formatter:"date",formatoptions:{srcformat:"Y-m-d H:i:s",newformat:"H:i"}},{label:"机温",name:"F_T",width:35,align:"center"},{label:"收缩压",name:"F_SSY",width:60,align:"center",hidden:!0},{label:"舒张压",name:"F_SZY",width:60,align:"center",hidden:!0},{label:"血压",name:"pressure",width:100,align:"center",formatter:function(n,t,i){return i.F_SSY+" / "+i.F_SZY}},{label:"脉搏",name:"F_HR",width:50,align:"center"},{label:"血流速",name:"F_BF",width:60,align:"center"},{label:"动脉压",name:"F_A",width:60,align:"center"},{label:"静脉压",name:"F_V",width:60,align:"center"},{label:"电导率",name:"F_C",width:60,align:"center"},{label:"TMP",name:"F_TMP",width:60,align:"center"},{label:"超滤率",name:"F_UFV",width:50,align:"center"},{label:"剩余肝素量",name:"F_GSL",width:50,align:"center"},{label:"超滤量",name:"F_UFR",width:50,align:"center"},{label:"记录者",name:"F_NurseName",width:50,align:"center"},{label:"症状及处理",name:"F_MEMO",width:200,align:"left",sortable:!1}],sortname:"F_NurseOperatorTime desc",viewrecords:!0});$.when(n,t,i,r,u);n=$.ajax({url:"/PatientManage/Patient/GetSelectJson",dataType:"json",async:!1,success:function(n){var t=[],i={};i.id="";i.text="";t.push(i);$.each(n,function(n,i){var r={};r.id=i.id;r.text=i.name+"(No."+i.recordNo+")"+i.py;t.push(r)});$("#F_Pid").bindSelect({search:!0,data:t,change:function(n){!n.id||$.ajax({url:"/PatientManage/Patient/GetFormJson",data:{keyValue:n.id},dataType:"json",async:!1,success:function(n){$("#F_DialysisNo").val(n.F_DialysisNo);$("#F_RecordNo").val(n.F_RecordNo);$("#F_Name").val(n.F_Name);$("#F_Gender").val(n.F_Gender);$("#F_BirthDay").val(n.F_BirthDay);$("#F_InpNo").val(n.F_InpNo);$("#F_BedNo").val(n.F_BedNo);$("#F_DialysisNo ,#F_Name,#F_Gender").attr("readonly","readonly")}})}})}});$("#F_GroupName").bindSelect({url:"/SystemManage/ItemsData/GetSelectJson?enCode=BedGroup",id:"id",text:"text",change:function(n){$.ajax({url:"/PatientManage/DialysisMachine/GetSelectJson",data:{enCode:n.id},dataType:"json",async:!1,success:function(n){$("#F_DialysisBedNo").html("");$("#F_DialysisBedNo").bindSelect({data:n})}})}});$("#F_VisitNo").bindSelect();$("#F_PatientSourse").bindSelect();$("#F_DialysisType").bindSelect({url:"/SystemManage/ItemsData/GetSelectJson?enCode=DialysisType",id:"id",text:"text",change:function(n){n.id=="HDF"?$("#hdhp").show():$("#hdhp").hide()}});t=$.ajax({url:"/PatientManage/Material/GetSelectJson",dataType:"json",async:!1,success:function(n){var t=[],i={};i.id="";i.text="";t.push(i);$.each(n,function(n,i){var r={};r.id=i.id;r.text=i.text;t.push(r)});$("#F_DialyzerType1").bindSelect({data:t})}});i=$.ajax({url:"/PatientManage/Material/GetSelectByTypeJson",data:{keyword:"灌流器"},dataType:"json",async:!1,success:function(n){var t=[],i={};i.id="";i.text="";t.push(i);$.each(n,function(n,i){var r={};r.id=i.id;r.text=i.text;t.push(r)});$("#F_DialyzerType2").bindSelect({data:t})}});$("#F_VascularAccess").bindSelect();r=$.ajax({url:"/PatientManage/Drugs/GetSelectJson",dataType:"json",async:!1,success:function(n){var t=[],i={};i.id="";i.text="无肝素";t.push(i);$.each(n,function(n,i){var r={};r.id=i.id;r.text=i.text;t.push(r)});$("#F_HeparinType").bindSelect({id:"id",text:"text",data:t,change:function(n){var t=n.id;t?$.ajax({url:"/PatientManage/Drugs/GetFormJson",dataType:"json",data:{keyValue:t},async:!1,success:function(n){$("#HeparinUnit").html(n.F_DrugMiniSpec);$("#HeparinAddSpeedUnit").html(n.F_DrugMiniSpec+"/h");$("#F_HeparinUnit").val(n.F_DrugMiniSpec);$("#F_HeparinAddSpeedUnit").val(n.F_DrugMiniSpec+"/h")}}):($("#HeparinUnit").html(""),$("#HeparinAddSpeedUnit").html(""),$("#F_HeparinUnit").val(""),$("#F_HeparinAddSpeedUnit").val(""),$("#F_HeparinUnit").val(""),$("#F_HeparinAddSpeedUnit").val(""),$("#F_HeparinAmount").val(""),$("#F_HeparinAddAmount").val(""))}})}});$("#F_AccessName").bindSelect();$("#F_DilutionType").bindSelect();$("#F_Gender").bindSelect();u=$.ajax({url:"/SystemManage/User/GetUserSelectJson",data:{keyValue:null},dataType:"json",async:!1,success:function(n){var t=[],i={};i.id="";i.text="     ";t.push(i);$.each(n,function(n,i){var r={};r.id=i.id;r.text=i.text;t.push(r)});$("#F_RecordDoctor").bindSelect({id:"id",text:"text",data:t,search:!0});$("#F_PuncturePerson").bindSelect({id:"id",text:"text",data:t,search:!0});$("#F_StartPerson").bindSelect({id:"id",text:"text",data:t,search:!0});$("#F_CheckPerson").bindSelect({id:"id",text:"text",data:t,search:!0});$("#F_EndPerson").bindSelect({id:"id",text:"text",data:t,search:!0})}});$("#F_GroupName").trigger("change");$("#F_DialysisType").trigger("change");$("input[name='F_PGwzsz']").on("change",function(){$("#F_PGwzsz").val($("input[name='F_PGwzsz']:checked").val())});$("input[name='F_PGxftz1']").on("change",function(){$("#F_PGxftz1").val($("input[name='F_PGxftz1']:checked").val())});$("input[name='F_PGxftz3']").on("change",function(){$("#F_PGxftz3").val($("input[name='F_PGxftz3']:checked").val())});$("input[name='F_PGwzcx1']").on("change",function(){$("#F_PGwzcx1").val($("input[name='F_PGwzcx1']:checked").val())});$("input[name='F_DJMH']").on("change",function(){$("#F_DJMH").val($("input[name='F_DJMH']:checked").val())});$("input[name='F_DialyzerStatus']").on("change",function(){$("#F_DialyzerStatus").val($("input[name='F_DialyzerStatus']:checked").val())});$("input[name='F_FistulaStatus']").on("change",function(){var n=$("input[name='F_FistulaStatus']:checked").val();n=="其他"?$("#F_FistulaStatus").show():$("#F_FistulaStatus").hide();$("#F_FistulaStatus").val(n)});$("input[name='F_DuctOpeningStatus']").on("change",function(){var n=$("input[name='F_DuctOpeningStatus']:checked").val();n=="其他"?$("#F_DuctOpeningStatus").show():$("#F_DuctOpeningStatus").hide();$("#F_DuctOpeningStatus").val(n)});$("#btn-order").on("click",function(){if(!!selectid){var n=currentPid+"^"+$("#F_VisitDate").val().replace(" 00:00:00","")+"^"+$("#F_DialysisNo").val(),t=currentPid;!t||$.modalOpen({id:"ObDetails",title:"执行医嘱",url:"/PatientManage/PatVisit/ObDetails?keyValue="+n,width:"950px",height:"600px",callBack:function(n){top.frames[n].submitData()}})}});$("#btn-query").on("click",function(){var n=$("#date-list").val();!n||(selectid=n,setForm())});$("#btn-save").on("click",function(){!selectid||$.submitForm({url:"/PatientManage/PatVisit/SubmitForm",param:{entity:$("#mainContent").formSerialize(),keyValue:selectid},success:function(){}})});$("#btn-print").on("click",function(){!selectid||$.ajax({type:"post",url:"/PatientManage/PatVisit/GetReportImage",data:JSON.stringify({keyValue:selectid}),success:function(n){$("#print").html(n);$("#print").attr("style","display:block;");$("#print").jqprint();$("#print").attr("style","display:none;")}})});$("#filterkeyword").keydown(function(n){var i,r,t,u,f,e;if(n.keyCode===13)if(console.log(this,$("#filterkeyword").val()),i=$("#filterkeyword").val(),!i)refreshList();else{if(list==undefined||list.length==undefined||list.length===0||(r=parseInt($("#visitNo").val()),t=$.grep(list,function(n){return r==0||n.VisitNo==r}),t.length===0)||(u=$("#groupName").val(),!u||(t=$.grep(t,function(n){return n.GroupName===u})),t.sort(function(n,t){return parseInt(n.DialysisBedNo)-parseInt(t.DialysisBedNo)}),t.length===0))return!1;t=$.grep(t,function(n){return n.Py.indexOf(i)>=0||n.DialysisBedNo===i||n.Name.indexOf(i)>=0||n.DialysisNo==i});t.length>0&&(f=$("#patient-list"),f.empty(),t.forEach(function(n){f.append('<li class="list-group-item" id="'+n.Id+'"><span class="badge">'+n.GroupName+n.DialysisBedNo+'<\/span><h5 class="list-group-item-heading">'+n.Name+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+n.Gender+"&nbsp;&nbsp;"+n.AgeDesc+'<\/h5><p class="list-group-item-text">'+n.DialysisType+"&nbsp;&nbsp;&nbsp;"+n.VascularAccess+"&nbsp;&nbsp;&nbsp;"+n.HeparinType+"&nbsp;&nbsp;&nbsp;<\/p><\/li>")}),selectid="",currentPid="")}else n.keyCode===8&&(e=$("#filterkeyword").val(),e.length===1&&refreshList())})}function handleVisitDateChange(n){if(n!==undefined&&n.el.id!=="visitDate")return!1;var t=$("#visitDate").val();(t==null||t=="")&&(t=(new Date).Format("yyyy-MM-dd"));$.ajax({url:"/PatientManage/PatVisit/GetPatVisitListJson",dataType:"json",data:{visitDate:t},async:!1,success:function(n){list=n}});refreshList()}function refreshList(){var r=$("#patient-list"),t,n,i;if(r.empty(),t=parseInt($("#visitNo").val()),list==undefined||list.length==undefined||list.length===0){selectid="";currentPid="";return}n=$.grep(list,function(n){return t==0||n.VisitNo==t});i=$("#groupName").val();!i||(n=$.grep(n,function(n){return n.GroupName===i}));n.sort(function(n,t){return parseInt(n.DialysisBedNo)-parseInt(t.DialysisBedNo)});n.forEach(function(n){r.append('<li class="list-group-item" id="'+n.Id+'"><span class="badge">'+n.GroupName+n.DialysisBedNo+'<\/span><h5 class="list-group-item-heading">'+n.Name+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+n.Gender+"&nbsp;&nbsp;"+n.AgeDesc+'<\/h5><p class="list-group-item-text">'+n.DialysisType+"&nbsp;&nbsp;&nbsp;"+n.VascularAccess+"&nbsp;&nbsp;&nbsp;"+n.HeparinType+"&nbsp;&nbsp;&nbsp;<\/p><\/li>")});selectid="";currentPid=""}function queryHistory(){!currentPid||$.ajax({url:"/PatientManage/PatVisit/GetHistoryRecordsJson",data:{keyword:currentPid},dataType:"json",async:!0,success:function(n){var t=$("#date-list");t.empty();$.each(n,function(i){t.append($("<option><\/option>").val(n[i].id).html(n[i].text))})}})}function setForm(){if(selectid=="")return!1;$.ajax({url:"/PatientManage/PatVisit/GetFormJson",data:{keyValue:selectid},dataType:"json",async:!1,success:function(n){$("#mainContent").formSerialize(n);$("input[type='radio']").prop("checked",!1);!n.F_PGwzsz||$("input[name='F_PGwzsz'][value="+n.F_PGwzsz+"]").prop("checked",!0);!n.F_PGxftz1||$("input[name='F_PGxftz1'][value="+n.F_PGxftz1+"]").prop("checked",!0);!n.F_PGxftz3||$("input[name='F_PGxftz3'][value="+n.F_PGxftz3+"]").prop("checked",!0);!n.F_PGwzcx1||$("input[name='F_PGwzcx1'][value="+n.F_PGwzcx1+"]").prop("checked",!0);!n.F_DJMH||$("input[name='F_DJMH'][value="+n.F_DJMH+"]").prop("checked",!0);!n.F_DialyzerStatus||$("input[name='F_DialyzerStatus'][value="+n.F_DialyzerStatus+"]").prop("checked",!0);!n.F_FistulaStatus||(n.F_FistulaStatus=="正常"||n.F_FistulaStatus=="渗血"||n.F_FistulaStatus=="肿胀"?$("input[name='F_FistulaStatus'][value="+n.F_FistulaStatus+"]").prop("checked",!0):($("input[name='F_DuctOpeningStatus'][value=其他]").prop("checked",!0),$("#F_FistulaStatus").show()));!n.F_DuctOpeningStatus||(n.F_DuctOpeningStatus=="渗血"||n.F_DuctOpeningStatus=="红肿"||n.F_DuctOpeningStatus=="化脓"?$("input[name='F_DuctOpeningStatus'][value="+n.F_DuctOpeningStatus+"]").prop("checked",!0):($("input[name='F_DuctOpeningStatus'][value=其他]").prop("checked",!0),$("#F_DuctOpeningStatus").show()));reQueryData()}})}function reQueryData(){if(!selectid)$("#gridListOrders").jqGrid("clearGridData"),$("#gridListObs").jqGrid("clearGridData");else{var n=$.ajax({url:"/PatientManage/Orders/GetPerformedOrderListJson",data:{pid:currentPid,visitDate:$("#F_VisitDate").val()},dataType:"json",async:!1,success:function(n){$("#gridListOrders").jqGrid("clearGridData");$("#gridListOrders").setGridParam({data:n}).trigger("reloadGrid")}}),t=$.ajax({url:"/PatientManage/Nurse/GetListJson",data:{pid:currentPid,startDate:$("#F_VisitDate").val(),endDate:$("#F_VisitDate").val()},dataType:"json",async:!1,success:function(n){$("#gridListObs").jqGrid("clearGridData");$("#gridListObs").setGridParam({data:n}).trigger("reloadGrid")}});$.when(n,t)}}var list=[],selectid="",currentPid="";$(function(){initControl();$("#btn-refresh").trigger("click")});Date.prototype.Format=function(n){var i={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()},t;/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(t in i)new RegExp("("+t+")").test(n)&&(n=n.replace(RegExp.$1,RegExp.$1.length==1?i[t]:("00"+i[t]).substr((""+i[t]).length)));return n};
function initControl(){$("#NF-merge").click(function(){var n=getSelectRows();if(n.length==0)return!1;var t=!0,i=[],r=[];$.each(n,function(n,u){if(i.length===0)i.push(u.pid);else if(!($.inArray(u.pid,i)>=0))return $.modalMsg("请操作同一患者的检验项目！","warning"),t=!1,!1;if(!$.inArray(u.status,["1","2","3"]))return $.modalMsg("样本已送检，不能操作！","warning"),t=!1,!1;r.push({id:u.id})});t&&$.submitForm({url:"/LabLis/LabRequest/SampleMerge",param:{keyValue:JSON.stringify(r)},success:function(t){$.each(n,function(n,i){i.id==t.data.id?$.each(requestRecords,function(n,r){if(r.id==i.id)return requestRecords.splice(n,1,t.data),!1}):$.each(requestRecords,function(n,t){if(t.id==i.id)return requestRecords.splice(n,1),!1})});fillTable()}})});$("#NF-spit").click(function(){var t=$("#gridList"),n=t.jqGrid("getGridParam","selarrrow");if($.isArray(n))n.length==1&&$.modalOpen({id:"SpitForm",title:"拆分项目",url:"/LabLis/LabRequest/SpitForm?keyValue="+n[0],width:"800px",height:"600px",callBack:function(n){top.frames[n].submitForm()}});else return!1});$("#NF-delete").click(function(){var t=getSelectRows(),n;if(t.length==0)return!1;n=[];$.each(t,function(t,i){n.push({id:i.id})});$.deleteForm({url:"/LabLis/LabRequest/BatchDelete",prompt:"确定删除这"+n.length+"项吗？",param:{keyValue:JSON.stringify(n)},success:function(){$("#btn_search").trigger("click")}})});$("#NF-createbarcode").click(function(){var t=getSelectRows(),n;if(t.length==0)return!1;n=[];$.each(t,function(t,i){n.push({id:i.id})});$.submitForm({url:"/LabLis/LabRequest/BatchCreateBarcode",param:{keyValue:JSON.stringify(n)},success:function(){$("#btn_search").trigger("click")}})});$("#NF-printbarcode").click(function(){var n=$("#gridList").jqGrid("getGridParam","selarrrow");n.length>0&&$.modalOpen({id:"PrintBarcode",title:"打印条码",url:"/LabLis/LabRequest/PrintBarcode?keyword="+n.join(","),width:"930px",height:"600px",callBack:function(n){top.frames[n].submitForm()}})});$("#NF-matchbarcode").click(function(){var t=$("#gridList"),n=t.jqGrid("getGridParam","selarrrow");n.length==0?$.modalMsg("未选择数据!","warning"):$.modalOpen({id:"MatchingBarcode",title:"匹配条码",url:"/LabLis/LabRequest/MatchingBarcode?keyword="+n.join(","),width:"800px",height:"600px",callBack:function(n){top.frames[n].submitForm()}})});$("#NF-printcyd").click(function(){var u=$("#gridList"),t=u.jqGrid("getGridParam","selarrrow"),i,r;if(t.length==0)$.modalMsg("未选择数据!","warning");else{var f=$.grep(requestRecords,function(n){return $.inArray(n.id,t)>=0}),e={format:"CODE128",displayValue:!0,fontSize:20,height:45,fontOptions:"bold",width:2,marginTop:5},n=$("#printContent");n.empty();n.html("");n.append('<div class="a4-endwise"><\/div>');i=$("div.a4-endwise");r=$("#requestDate").val();$.each(f,function(n,t){var f=[],u;$.each(t.rows,function(n,t){f.push(t.shortName)});u="";n%12==0&&(n>0&&(u=u+'<div style="page-break-after:always;"><\/div>'),u=u+'                                <div class="page-header" style="text-align:center;margin-bottom: 25px;">                                  <h2>检验标本采样单<small>('+r+")<\/small><\/h2>                                <\/div>                                ");u=u+'                        <div class="thumbnail" style="float: left;margin-bottom: 15px;width: 33%;">                            <svg id="svg'+t.id+'" />                            <div class="caption" style="margin-top: -2px;padding: 1px;">                                <p style="margin: 0 0 1px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;">                                     '+t.name+""+(t.beInfected?"<sup>+<\/sup>":"")+"&nbsp;&nbsp;&nbsp;"+t.gender+"&nbsp;&nbsp;&nbsp;"+(t.birthDay==null?"":byage(t.birthDay.substr(0,10)))+'岁&nbsp;                                <\/p>                                <p style="margin: 0 0 1px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;">                                    '+t.sampleType+"&nbsp;&nbsp;&nbsp;"+t.container+'                                <\/p>                                <p style="height: 50px;margin: 0 0 1px;overflow: hidden;text-overflow: ellipsis;display:-webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp:4;font-size: 9px;font-weight: bold;word-break: break-all;">                                    '+f.join(",")+'                                <\/p>                                <p style="margin: 0 0 1px;">                                    <string>开单:<\/string>&nbsp;'+t.doctorName+"&nbsp;&nbsp;"+t.orderTime.substr(5,11)+'                                <\/p>                                <p style="margin: 0 0 1px;">                                    <string>采样:<\/string>&nbsp;'+(t.nurseName==null?"":t.nurseName)+"&nbsp;&nbsp;"+(t.samplingTime==null?"":t.samplingTime.substr(5,11))+"                                <\/p>                            <\/div>                        <\/div>                        ";i.append(u);$("#svg"+t.id).JsBarcode(t.barcode,e)});n.attr("style","display:block;");n.jqprint();n.attr("style","display:none;")}});$("#NF-sampling").click(function(){$.modalOpen({id:"ConfirmSample",title:"确认采集",url:"/LabLis/LabRequest/ConfirmSample",width:"500px",height:"300px",callBack:function(n){top.frames[n].submitForm()}})});$("#NF-download").click(function(){var t=$("#gridList"),n=t.jqGrid("getGridParam","selarrrow");n.length==0?$.modalMsg("未选择数据!","warning"):$.download("/LabLis/LabRequest/Download","keyValue="+n.join(","),"post")});$("#NF-upload").click(function(){var t=$("#gridList"),n=t.jqGrid("getGridParam","selarrrow");n.length==0?$.modalMsg("未选择数据!","warning"):$.submitForm({url:"/LabLis/LabRequest/Upload",param:{keyValue:n.join(",")},success:function(){}})})}function getSelectRows(){var n=$("#gridList"),t=[],i=n.jqGrid("getGridParam","selarrrow");return $.isArray(i)&&$.each(i,function(i,r){t.push(n.jqGrid("getRowData",r))}),t}function gridList(){var n=$("#gridList");n.jqGrid({datatype:"local",height:$(window).height()-135,colModel:[{label:"主键",name:"id",hidden:!0},{label:"患者ID",name:"pid",hidden:!0},{label:"姓名",name:"name",width:40,align:"left"},{label:"性别",name:"gender",width:25,align:"center"},{label:"状态",name:"status",width:70,align:"center",formatter:function(n){return n==1?"新申请":n==2?"已提交":n==3?"已采样":n==4?"正在检验":n==5?"已审核":n==6?"已打印":void 0}},{label:"条码号",name:"barcode",width:95,align:"left",formatter:function(n){return"<strong>"+(n==null?"":n)+"<\/strong>"}},{label:"检验项目",name:"itemDesc",width:250,align:"left",formatter:function(n,t,i){var r=[];return $.each(i.rows,function(n,t){r.push(t.shortName)}),r.join(",")}},{label:"样本类型",name:"sampleType",width:70,align:"left"},{label:"样本容器",name:"container",width:80,align:"left"},{label:"采样时间",name:"samplingTime",width:120,align:"left"},{label:"签收时间",name:"testTime",width:120,align:"left"},{label:"审核时间",name:"auditTime",width:120,align:"left"},{label:"报告时间",name:"reportTime",width:120,align:"left"}],pager:"#gridPager",sortname:"name asc",recordpos:"left",viewrecords:!0,multiselect:!0,onSelectRow:function(){var n=$(".operate"),t=$("#gridList").jqGrid("getGridParam","selarrrow");t.length>0?(!0&&n.animate({left:0},10),n.find("li.first").find("span").text(t.length)):n.animate({left:"-100.1%"},10);n.find(".close").click(function(){n.animate({left:"-100.1%"},200)})},autowidth:!0,shrinkToFit:!1,gridview:!0})}function queryRecords(n){$.ajax({url:"/LabLis/LabRequest/GetlistJson",data:{requestDate:n},dataType:"json",async:!1,success:function(n){requestRecords=n}})}function requestDateChanged(n){n.el.id=="requestDate"&&(queryRecords(n.el.realValue),fillTable())}function fillTable(){var t=[],i=$("#txt_condition .dropdown-text").attr("data-value"),n;t=i==null||i==""?requestRecords:$.grep(requestRecords,function(n){return n.status==i});n=$("#txt_keyword").val();n!=null&&n!=""&&(t=$.grep(requestRecords,function(t){return t.name.indexOf(n)>=0||t.dialysisNo==n||t.patientNo==n||t.recordNo==n}));$("#gridList").jqGrid("clearGridData").setGridParam({data:t}).trigger("reloadGrid")}function byage(n){var i,r=n.split("-"),f=r[0],e=r[1],l=r[2],u=new Date,o=u.getFullYear(),s=u.getMonth()+1,a=u.getDate(),t,h,c;return o==f?i=0:(t=o-f,t>0?s==e?(h=a-l,i=h<0?t-1:t):(c=s-e,i=c<0?t-1:t):i=-1),i}var requestRecords=[],selectID="";$(function(){$("#txt_condition .dropdown-menu li").click(function(){var n=$(this).find("a").html(),t=$(this).find("a").attr("data-value");$("#txt_condition .dropdown-text").html(n).attr("data-value",t);fillTable()});gridList();var n=(new Date).Format("yyyy-MM-dd");$("#requestDate").val(n);$("#btn_search").click("click",function(){queryRecords($("#requestDate").val());fillTable()});queryRecords(n);fillTable();initControl()});Date.prototype.Format=function(n){var i={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()},t;/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(t in i)new RegExp("("+t+")").test(n)&&(n=n.replace(RegExp.$1,RegExp.$1.length==1?i[t]:("00"+i[t]).substr((""+i[t]).length)));return n};
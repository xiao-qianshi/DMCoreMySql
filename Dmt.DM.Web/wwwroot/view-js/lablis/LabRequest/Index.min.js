function initControl(){$("#status_horizon a").on("click",function(){$("#status_horizon a.active").removeClass("active");$(this).addClass("active");var n=$(this).attr("data-value");queryRequest($("#requestDate").val(),n)});$("#btn-eye").on("click",function(){$("#order-panel").toggle("normal",function(){$(this).css("display")==="none"?$("#btn-eye").find("i").removeClass("fa-eye-slash").addClass("fa-eye"):$("#btn-eye").find("i").removeClass("fa-eye").addClass("fa-eye-slash")})});$("#btn-choosepatient").on("click",function(){$.modalOpen({id:"ChoosePatient",title:"选择患者",url:"/LabLis/LabRequest/ChoosePatient",width:"800px",height:"600px",callBack:function(n){top.frames[n].submitForm()}})});$("#btn-choosepatientbyvisit").on("click",function(){$.modalOpen({id:"ChoosePatientByVisit",title:"选择患者",url:"/LabLis/LabRequest/ChoosePatientByVisit?keyValue="+$("#requestDate").val(),width:"800px",height:"600px",callBack:function(n){top.frames[n].submitForm()}})});$("#btn-clearpatient").on("click",function(){clearpatients()});$("#btn-chooseitem").on("click",function(){$.modalOpen({id:"Form",title:"选择项目",url:"/LabLis/LabRequest/ChooseLabItem",width:"800px",height:"600px",callBack:function(n){top.frames[n].submitForm()}})});$("#btn-clearitem").on("click",function(){clearitems()});$("#btn-query").on("click",function(){var n=$("#status_horizon a.active").attr("data-value");queryRequest($("#requestDate").val(),n)});$("#btn-save").on("click",function(){var n=[],t=[];if($.each(selectedPatients,function(t,i){n.push({id:i.id})}),$.each(selectedItems,function(n,i){t.push({id:i.id})}),n.length==0||t.length==0)return!1;$.submitForm({url:"/LabLis/LabRequest/BatchCreateSheet",param:{pids:JSON.stringify(n),itemids:JSON.stringify(t)},success:function(){var n=$("#status_horizon a.active").attr("data-value");queryRequest($("#requestDate").val(),n)}})});$("#btn-batchsign").on("click",function(){$.modalConfirm("注：您确定要提交全部申请吗？",function(n){if(n){var t=$("#requestDate").val();t==""&&(t=(new Date).Format("yyyy-MM-dd"));$.submitForm({url:"/LabLis/LabRequest/BatchSign",param:{requestDate:t},success:function(){var n=$("#status_horizon a.active").attr("data-value");queryRequest(t,n)}})}})})}function queryRequest(n,t){n==""&&(n=(new Date).Format("yyyy-MM-dd"));$.ajax({url:"/LabLis/LabRequest/GetlistJson",data:{requestDate:n,requestStatus:t},dataType:"json",async:!1,success:function(n){fillPanel(n)}})}function fillPanel(n){$("#sheetsBody").empty();$("#sheetsBody").html("");$.each(n,function(n,t){var i=[],r,u;$.each(t.rows,function(n,t){i.push(t.shortName)});r=t.status==1||t.status==2;u=t.status==1;$("#sheetsBody").append('                    <div class="col-xs-6 col-sm-5 col-md-4 col-lg-3" id="'+t.id+'">                        <div class="panel panel-default" style="width: 95%;">                            <div class="panel-heading">                                <strong>'+t.name+'<\/strong>                                <span class="badge">'+t.rows.length+"<\/span>                                <strong>"+(t.barcode==null?"":t.barcode)+"<\/strong>                                "+(r?'<i class="fa fa-trash fa-lg" style="float: right;margin-right: 5px;"><\/i>':"")+"                                "+(u?'<i class="fa fa-pencil fa-lg" style="float: right;margin-right: 15px;"><\/i>':"")+'                            <\/div>                            <div class="panel-body">                                <p>                                    '+i.join(",")+'                                <\/p>                            <\/div>                            <div class="panel-footer">                                <strong>时间:'+t.orderTime.substr(5,11)+'<\/strong>                                <strong style="float: right;">'+t.doctorName+"<\/strong>                            <\/div>                        <\/div>                    <\/div>                    ")});$("#sheetsBody i.fa").on("click",function(n){var t=$(n.currentTarget).parent().parent().parent(),i=t[0].id;$(this).is(".fa-trash")?$.modalConfirm("注：您确定要【删除】该项吗？",function(n){n&&$.submitForm({url:"/LabLis/LabRequest/DeleteForm",param:{keyValue:i},success:function(){t.remove()}})}):$(this).is(".fa-pencil")&&$.modalConfirm("注：您确定要【提交】该项吗？",function(n){n&&$.submitForm({url:"/LabLis/LabRequest/SignForm",param:{keyValue:i},success:function(){t.remove()}})})})}function setpatients(n){var t=$("#selectedPatients");$.each(n,function(n,i){var r=$.grep(selectedPatients,function(n){return n.id==i.id});if(r.length===0){selectedPatients.push(i);t.append('                        <div class="col-xs-3 col-sm2 col-md-1 col-lg-1">                            <strong>'+i.name+(i.beInfected?'<i class="fa fa-circle fa-sm" style="color: orangered;"><\/i>':"")+'<\/strong>&nbsp;<i class="fa fa-times fa-lg" id="'+i.id+'"><\/i>                        <\/div>                        ');$("#"+i.id).on("click",function(n){$(n.currentTarget).parent().remove();selectedPatients=$.grep(selectedPatients,function(t){return t.id!=n.currentTarget.id})})}})}function setitems(n){var t=$("#selectedItems");$.each(n,function(n,i){var r=$.grep(selectedItems,function(n){return n.id==i.id});if(r.length===0){selectedItems.push(i);t.append('                         <div class="col-xs-5 col-sm4 col-md-3 col-lg-2">                        <i>'+i.name+"<\/i>&nbsp;&nbsp;"+(i.isExternal?'<span class="label label-danger">外<\/span>':"")+'&nbsp;&nbsp;<i class="fa fa-times fa-lg" id="'+i.id+'"><\/i>                        <\/div>                        ');$("#"+i.id).on("click",function(n){$(n.currentTarget).parent().remove();selectedItems=$.grep(selectedItems,function(t){return t.id!=n.currentTarget.id})})}})}function clearpatients(){var n=$("#selectedPatients");n.empty();n.html("");selectedPatients=[]}function clearitems(){var n=$("#selectedItems");n.empty();n.html("");selectedItems=[]}var selectedPatients=[],selectedItems=[];$(function(){$("#requestDate").val((new Date).Format("yyyy-MM-dd"));initControl();$("#btn-query").trigger("click")});Date.prototype.Format=function(n){var i={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()},t;/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(t in i)new RegExp("("+t+")").test(n)&&(n=n.replace(RegExp.$1,RegExp.$1.length==1?i[t]:("00"+i[t]).substr((""+i[t]).length)));return n};
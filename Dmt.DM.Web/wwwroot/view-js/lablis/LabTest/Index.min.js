function initControl(){$("#testDate").val((new Date).Format("yyyy-MM-dd"));$("#sample-list").height($(window).height()-173);$("#btn-choose").click(function(){$.modalOpen({id:"ChooseInstrument",title:"选择设备",url:"/LabLis/LabInstrument/ChooseInstrument",width:"800px",height:"600px",callBack:function(n){top.frames[n].submitForm()}})});$("#btn-search").click(function(){queryTestList();setHeaderCount();setSampleList()});$("#status_horizon a.btn-default").click(function(){$("#status_horizon a.btn-default").removeClass("active");$(this).addClass("active");setSampleList()});$("#btn-assign").click(function(){var n=$("#testDate").val(),t;if(n==""||currentInstrumentId=="")return!1;t=[currentInstrumentId,n];$.modalOpen({id:"Assign",title:"条码编号",url:"/LabLis/LabTest/Assign?keyword="+t.join(","),width:"450px",height:"300px",callBack:function(n){top.frames[n].submitForm()}})});$("#btn-audit").click(function(){var n=getCurrentTestId();!n||$.submitForm({url:"/LabLis/LabTest/AuditTest",param:{keyValue:n},success:function(){}})});gridList()}function btn_additem(){var t=getCurrentTestId(),n;if(!!t){if(currentTestStatus==3)return $.modalAlert("已审核","warning"),!1;n=[currentInstrumentId];$.each(resultList,function(t,i){n.push(i.F_Code)});$.modalOpen({id:"AddItem",title:"添加子项",url:"/LabLis/LabTest/AddItem?keyword="+n.join(","),width:"650px",height:"450px",callBack:function(n){top.frames[n].submitForm()}})}}function appendItem(n){var t=getCurrentTestId();!t||($.each(n,function(n,t){resultList.push({F_Code:t.F_Code,F_LowRef:t.F_ReferenceMinValue,F_MethodName:"",F_Name:t.F_Name,F_ShortName:t.F_CnName,F_Sorter:t.F_Sorter,F_Unit:t.F_ValueUnit,F_UpperRef:t.F_ReferenceMaxValue,F_ItemId:t.F_Id,F_Flag:""})}),resultList=resultList.sort(function(n,t){return n.F_Sorter-t.F_Sorter}),$("#gridList").jqGrid("clearGridData").setGridParam({data:resultList}).trigger("reloadGrid"))}function btn_deleteitem(){var r=getCurrentTestId(),n,t,i;if(!!r){if(currentTestStatus==3)return $.modalAlert("已审核","warning"),!1;if(n=$("#gridList"),t=n.jqGrid("getGridParam","selarrrow"),t.length==0)return!1;i=[];$.each(t,function(t,r){var u=n.jqGrid("getRowData",r);i.push(u.F_ItemId)});resultList=$.grep(resultList,function(n){return $.inArray(n.F_ItemId,i)<0});resultList=resultList.sort(function(n,t){return n.F_Sorter-t.F_Sorter});n.jqGrid("clearGridData").setGridParam({data:resultList}).trigger("reloadGrid")}}function btn_setdefault(){}function btn_saveitem(){var n=getCurrentTestId();if(!!n){if(currentTestStatus==3)return $.modalAlert("已审核","warning"),!1;if(resultList.length==0)return!1;$.submitForm({url:"/LabLis/LabTest/SubmitItemData",param:{testId:n,items:JSON.stringify(resultList)},success:function(n){$.isArray(n.data)&&(resultList=n.data,$("#gridList").jqGrid("clearGridData").setGridParam({data:resultList}).trigger("reloadGrid"))}})}}function btn_critical(){}function getCurrentTestId(){var n=$("#sample-list").find("a.selected-a");return n.length==0?"":n[0].id}function gridList(){var n=$("#gridList");n.jqGrid({datatype:"local",height:$(window).height()-220,colModel:[{label:"主键",name:"F_Id",hidden:!0},{label:"排序号",name:"F_Sorter",hidden:!0},{label:"代码",name:"F_Code",width:50,align:"left"},{label:"名称",name:"F_Name",width:80,align:"left"},{label:"简称",name:"F_ShortName",width:50,align:"center"},{label:"结果",name:"F_Result",width:50,align:"left",editable:!0},{label:"单位",name:"F_Unit",width:40,align:"left"},{label:"文本结果",name:"F_ResultText",width:200,align:"left",editable:!0},{label:"标识",name:"F_Flag",width:40,align:"center",formatter:function(n){return n=="L"?'<i class="fa fa-arrow-down" style="color:#eba589"><\/i>':n=="H"?'<i class="fa fa-arrow-up" style="color:#87ceeb"><\/i>':""}},{label:"危急值",name:"F_IsCritical",width:40,align:"center",formatter:function(n){return n==!0?'<i class="fa fa-circle" style="color: red;"><\/i>':""}},{label:"参考下限",name:"F_LowRef",width:60,align:"left"},{label:"参考上限",name:"F_UpperRef",width:60,align:"left"},{label:"检测方法",name:"F_MethodName",width:150,align:"left"},{label:"子项代码",name:"F_ItemId",hidden:!0}],pager:"#gridPager",sortname:"F_Sorter asc",recordpos:"left",viewrecords:!0,multiselect:!0,autowidth:!0,rownumbers:!0,shrinkToFit:!1,gridview:!0,cellEdit:!0,cellsubmit:"clientArray",beforeEditCell:function(){},afterSaveCell:function(n,t,i,r,u){u==7?resultList[n-1].F_Result=i:u==9&&(resultList[n-1].F_ResultText=i)}})}function resetTitle(n){!n||$.each(machineList,function(t,i){i.F_Id==n&&(setHeader(i),currentInstrumentId=i.F_Id,queryTestList(),setSampleList(),setHeaderCount())})}function handleDateChange(n){n!==undefined&&n.el.id=="testDate"&&$("#btn-search").trigger("click")}function queryTestList(){var n=$("#testDate").val();!currentInstrumentId||$.ajax({url:"/LabLis/LabTest/GetDetailedListJson",dataType:"json",data:{testDate:n,instrumentId:currentInstrumentId},async:!1,success:function(n){testList=$.isArray(n)?n:[]}})}function setSampleList(){var n=$("#sample-list"),t,i;n.empty();n.html("");t=$("#status_horizon a.active").attr("data-value");i=testList;!t||(i=$.grep(testList,function(n){return n.status==t}));$.each(i,function(t,i){var r=[];$.each(i.items,function(n,t){r.push(t.itemShortName)});n.append('                                <a class="list-group-item" id="'+i.id+'">                                    <span class="badge">'+i.testNo+'<\/span>                                    <h5 class="list-group-item-heading">                                        <strong>'+i.barcode+"<\/strong>&nbsp;&nbsp;&nbsp;&nbsp;                                       "+i.sampleType+'                                    <\/h5>                                    <p class="list-group-item-text">                                         <strong>'+i.patientName+"<\/strong>&nbsp;&nbsp;"+i.patientGender+"&nbsp;&nbsp;"+i.patientAgeStr+"&nbsp;&nbsp;"+i.dialysisNo+'&nbsp;&nbsp;                                    <\/p>                                    <p class="list-group-item-text">                                        '+r.join(",")+"                                    <\/p>                                <\/a>                                ")});n.find("a").click(function(t){n.find("a.selected-a").removeClass("selected-a");$(this).addClass("selected-a");setTestStatus(t.currentTarget.id);queryReport(t.currentTarget.id)})}function setTestStatus(n){$.each(testList,function(t,i){if(i.id==n)return currentTestStatus=i.status,!1})}function setHeader(n){$("#h-instrumentCode").html(n.F_Code);$("#h-instrumentName").html(n.F_Name);n.F_IsExternal?$("#h-isExternal").attr("style","display: inline;"):$("#h-isExternal").attr("style","display: none;");n.F_IsDuplex?$("#h-isDuplex").removeClass().addClass("fa").addClass("fa-arrows-h"):$("#h-isDuplex").removeClass().addClass("fa").addClass("fa-arrows-right");$("#h-workStationIp").html(n.F_WorkStationIp)}function setHeaderCount(){var n=0,t=0,i=0;$.each(testList,function(r,u){u.status==0?n++:u.status==1?t++:u.status==2&&i++;$("#span-count1").html(n);$("#span-count2").html(t);$("#span-count3").html(i)})}function queryReport(n){$.ajax({url:"/LabLis/LabTest/GetResultListJson",dataType:"json",data:{keyValue:n},async:!1,success:function(n){resultList=$.isArray(n)?n:[];var t=$("#gridList");t.jqGrid("clearGridData").setGridParam({data:resultList,cellEdit:currentTestStatus!=3}).trigger("reloadGrid")}})}var currentInstrumentId="",machineList=[],testList=[],currentTestStatus=0,resultList=[];$(function(){initControl();$.ajax({url:"/LabLis/LabInstrument/GetListJson",dataType:"json",async:!1,success:function(n){if($.isArray(n)){if(n.length==0)return $.modalMsg("请先添加检验仪器！","warning"),!1;currentInstrumentId=n[0].F_Id;machineList=n;setHeader(n[0]);queryTestList();setSampleList();setHeaderCount()}else return $.modalMsg("查询检验仪器出错！","warning"),!1}})});Date.prototype.Format=function(n){var i={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()},t;/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(t in i)new RegExp("("+t+")").test(n)&&(n=n.replace(RegExp.$1,RegExp.$1.length==1?i[t]:("00"+i[t]).substr((""+i[t]).length)));return n};
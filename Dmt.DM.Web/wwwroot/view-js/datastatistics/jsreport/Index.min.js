function initControl(){var n=$.ajax({url:"/DataStatistics/JSReport/GetMonthOptionsJson",dataType:"json",async:!1,success:function(n){var t=[],i;$.each(n,function(n,i){t.push({id:n,text:i})});t.sort(function(n,t){return n.id-t.id});i=$("ul.dropdown-menu");$.each(t,function(n,t){t.id==0&&$("#txt_condition .dropdown-text").html(t.text).attr("data-value",t.text);i.append('<li><a data-value="'+t.text+'">'+t.text+"<\/a><\/li>")})}}),t=$.ajax({url:"/PatientManage/Patient/GetSelectJson",dataType:"json",async:!1,success:function(n){$.isArray(n)&&(patientList=n,patientList.sort(function(n,t){return n.name-t.name}))}});$.when(n,t);$("#txt_condition .dropdown-menu li").click(function(){var t=$(this).find("a").html(),n=$(this).find("a").attr("data-value");$("#txt_condition .dropdown-text").html(t).attr("data-value",n);queryRecord(n);$("#btn_search").trigger("click")});$("#btn_search").click(function(){var n=$("#txt_keyword").val();fillTable(n)})}function gridList(){var n=$("#gridList");n.jqGrid({datatype:"local",height:$(window).height()-128,colModel:[{label:"主键",name:"recordNo",hidden:!0},{label:"患者主键",name:"patientId",hidden:!0},{label:"月份",name:"monthDesc",width:60,align:"left"},{label:"姓名",name:"patientName",width:60,align:"left"},{label:"病历号",name:"patientNo",width:60,align:"left"},{label:"文件名",name:"fileName",width:145,align:"left"},{label:"文件路径",name:"filePath",width:370,align:"left"},{label:"是否下载",name:"hasDownload",width:60,align:"left",formatter:function(n,t,i){return n==!0?'<span class="label label-success">已下载<\/span>':i.isCompleted==!0?'<span class="label label-default">未下载<\/span>':""}},{label:"下载时间",name:"downloadTime",width:120,align:"left",formatter:"date",formatoptions:{srcformat:"Y-m-d H:i",newformat:"Y-m-d H:i"}},{label:"创建时间",name:"creatorTime",width:120,align:"left",formatter:"date",formatoptions:{srcformat:"Y-m-d H:i",newformat:"Y-m-d H:i"}}],pager:"#gridPager",sortname:"patientName asc",recordpos:"left",viewrecords:!0,multiselect:!0,onSelectRow:function(){var n=$(".operate"),t=$("#gridList").jqGrid("getGridParam","selarrrow");t.length>0?(!0&&n.animate({left:0},10),n.find("li.first").find("span").text(t.length)):n.animate({left:"-100.1%"},10);n.find(".close").click(function(){n.animate({left:"-100.1%"},200)})},autowidth:!0,rownumbers:!0,shrinkToFit:!1,gridview:!0})}function btn_query(){var n=$("#txt_condition .dropdown-text").attr("data-value");queryRecord(n);$("#btn_search").trigger("click")}function btn_create(){var t=$("#gridList"),i=t.jqGrid("getGridParam","selarrrow"),n;if(i.length==0)return!1;n=[];$.each(i,function(i,r){var u=t.jqGrid("getRowData",r);u.isCompleted||n.push(u.patientId)});n.length>0&&$.submitForm({url:"/DataStatistics/JSReport/SubmitData",param:{month:$("#txt_condition .dropdown-text").attr("data-value"),ids:n.join(",")},success:function(){}})}function btn_download(){var t=$("#gridList"),i=t.jqGrid("getGridParam","selarrrow"),n;if(i.length==0)return!1;n=[];$.each(i,function(i,r){var u=t.jqGrid("getRowData",r);!u.recordNo||n.push(u.recordNo)});n.length>0&&$.download("/DataStatistics/JSReport/Download","ids="+n.join(","),"post")}function btn_delete(){var t=$("#gridList"),i=t.jqGrid("getGridParam","selarrrow"),n;if(i.length==0)return!1;n=[];$.each(i,function(i,r){var u=t.jqGrid("getRowData",r);!u.recordNo||n.push(u.recordNo)});n.length>0&&$.deleteForm({url:"/DataStatistics/JSReport/DeleteData",param:{ids:n.join(",")},success:function(){btn_query()}})}function queryRecord(n){$.ajax({url:"/DataStatistics/JSReport/GetListJson",dataType:"json",data:{month:n},async:!1,success:function(t){$.isArray(t)&&(gridData=[],$.each(patientList,function(i,r){var u={patientId:r.id,patientName:r.name,patientNo:r.recordNo,py:r.py,idealWeight:r.idealWeight,beInfected:r.beInfected},f=-1;$.each(t,function(n,t){if(u.patientId==t.F_PId)return f=n,u.recordNo=t.F_Id,u.monthDesc=t.F_MonthDesc,u.fileName=t.F_FileName,u.fileSize=t.F_FileSize,u.filePath=t.F_FilePath,u.isCompleted=t.F_IsCompleted,u.hasDownload=t.F_HasDownload,u.downloadTime=t.F_DownloadTime,u.creatorTime=t.F_CreatorTime,!1});f>=0?t.splice(f,1):(u.recordNo=null,u.monthDesc=n,u.fileName=null,u.fileSize=null,u.filePath=null,u.isCompleted=null,u.hasDownload=null,u.downloadTime=null,u.creatorTime=null);gridData.push(u)}))}})}function fillTable(n){var t=[];t=n?$.grep(gridData,function(t){return t.patientName.indexOf(n)>=0||t.py.toUpperCase().indexOf(n.toUpperCase())>=0}):gridData;$("#gridList").jqGrid("clearGridData").setGridParam({data:t}).trigger("reloadGrid")}var patientList=[],gridData=[];$(function(){initControl();gridList();btn_query()});